# 코드 에이전트 컨텍스트 관리 연구

> JobRunner 프로젝트 범위 외 연구 문서.
> "개발 작업 밤새 알아서 작업해주는 환경" 구현을 위한 아이디어 정리.

---

## 목표

**Local LLM이 코드베이스에서 효과적으로 작업할 수 있도록 컨텍스트를 제공하는 방법 연구.**

---

## 핵심 문제

| 문제 | 설명 |
|------|------|
| **컨텍스트 크기** | Local LLM은 컨텍스트 윈도우가 제한적. 전체 코드베이스를 주입할 수 없음. |
| **컨텍스트 품질** | 어떤 정보를 주느냐에 따라 작업 품질이 크게 달라짐. |
| **Cloud LLM 의존도** | 오픈소스 대부분이 Cloud LLM에 최적화되어 있음. |

---

## 접근 방식

### 1. Host Agent 초안 + Local LLM 실행/수정

```
Host Agent: 컨텍스트 분석 + 초안 코드 생성
    ↓
Local LLM: 실행 → 에러 확인 → 수정 (반복)
    ↓
완료 또는 Host Agent 에스컬레이션
```

**장점:**
- Host Agent의 강력한 이해력으로 초안 품질 높음
- Local LLM은 단순 반복 작업에 집중
- Host Agent 토큰 소비는 1회, 반복은 Local LLM 담당

**적합한 케이스:**
- 기능 구현이 명확한 작업
- 인터페이스가 이미 정의된 작업

---

### 2. AST 기반 컨텍스트 추출

전체 코드 대신 최소 컨텍스트만 추출:

```python
# 추출 대상
- 수정 대상 함수/클래스의 AST
- 관련 import/dependency
- 타입 힌트/인터페이스 정의
- 관련 테스트 코드
```

**장점:**
- 컨텍스트 크기 최소화
- Local LLM 부담 감소

**구현 난이도:** 중간 (Python AST 모듈 활용)

---

### 3. Test-Driven 분배

```
Host Agent: 실패하는 테스트 케이스 작성
    ↓
Local LLM: "이 테스트 통과시켜" (명확한 목표)
    ↓
테스트 통과 = 작업 완료
```

**장점:**
- Local LLM의 목표가 명확
- 자동 검증 가능 (테스트 실행)

**적합한 케이스:**
- 테스트 작성이 명확한 경우
- 테스트 작성이 어려우면 Host Agent 판단 작업으로 전환

---

### 4. User 협업 워크플로우 (핵심)

User도 시스템에 맞게 작업하는 방식:

```
[User]
    │
    ▼
인터페이스 + pseudo code 작성
    │
    ▼
[Host Agent]
    │
    ▼
작업 분배 (AST 컨텍스트 추출)
    │
    ▼
[Local LLM]
    │
    ▼
구체화 + 유닛테스트 생성 + 테스트 통과
    │
    ▼
[User + Host Agent]
    │
    ▼
코드 리뷰
    │
    ├─→ Merge
    │
    └─→ 재작업 지시 (Local LLM 또는 Host Agent)
```

**핵심 원칙:**
1. **User**: 인터페이스/계약 정의에 집중 (무엇을 할지)
2. **Host Agent**: 작업 분배 + 판단 + 리뷰 (어떻게 나눌지)
3. **Local LLM**: 구체화 + 테스트 (어떻게 구현할지)

---

## Local LLM 작업 범위 정의

| 가능 (Local LLM) | 불가능 (Host Agent 필요) |
|-----------------|------------------------|
| 인터페이스 구현 | 아키텍처 설계 |
| 유닛테스트 생성/통과 | 복잡한 의존성 분석 |
| 단순 버그 수정 | 성능 최적화 판단 |
| 리팩토링 (명확한 지시) | 요구사항 해석 |

---

## 오픈소스 참고

| 프로젝트 | 참고 포인트 | Local LLM 호환 |
|----------|------------|---------------|
| **Aider** | Git 연동, 자동 커밋 | 일부 지원 |
| **Continue.dev** | IDE 컨텍스트 관리 | Ollama 지원 |
| **OpenDevin** | 에이전트 프레임워크 | 연동 가능 |
| **SWE-agent** | 코드 수정 + 테스트 자동화, 벤치마크(SWE-bench) 강점 | Cloud 중심 (참고용) |

→ 컨텍스트 관리 방식 참조, 실행 부분은 직접 구현

---

## 코드베이스 임베딩 전략

### 단계적 접근

```
[1단계] Host Agent 최적화
    │
    │  "Host Agent가 코드 맥락 파악을 쉽게 해서 더 명령을 잘 내리게 함"
    │
    ▼
[2단계] 성숙 후 Local LLM 확장
    │
    │  Local LLM도 계속 발전, 오픈소스도 발전
    │  → 기반이 갖춰지면 Local LLM에도 적용
    │
    ▼
[결과] 점진적 기반 구축 완료
```

### 1단계: Host Agent 최적화

| 목적 | 효과 |
|------|------|
| Host Agent가 코드베이스 맥락을 빠르게 파악 | 더 정확한 작업 분배 |
| 관련 파일/함수 자동 탐색 | 컨텍스트 수동 입력 불필요 |
| 의존성/영향 범위 분석 | 실수 줄임 |

**구현 항목:**
- 코드베이스 임베딩 (Vector DB)
- 의존성 그래프 (Graph DB 또는 AST 분석)
- 검색 인터페이스 (MCP 또는 CLI)

### 2단계: Local LLM 확장

**조건:**
- 1단계 시스템 성숙
- Local LLM 성능 향상 (컨텍스트 윈도우, 코드 이해력)
- 오픈소스 생태계 발전

**확장 방향:**
- Local LLM도 동일한 검색 인터페이스 사용
- Host Agent 없이도 자율적 컨텍스트 탐색

---

## 구현 로드맵 (JobRunner 이후)

1. **Phase A**: Host Agent 초안 + Local LLM 실행/수정 패턴 구현
2. **Phase B**: AST 기반 컨텍스트 추출 도구 개발
3. **Phase C**: Test-Driven 분배 자동화
4. **Phase D**: User 협업 워크플로우 통합

---

## 관련 문서

- [PROJECT_REQUIREMENTS.md](../specification/PROJECT_REQUIREMENTS.md)
- [MODULES.md](../specification/MODULES.md)
